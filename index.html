<!DOCTYPE html>
<html>
<head>
  <title>Path Project</title>
  <style>
    /* --- PATH PROJECT THEME --- */
    :root {
      --bg-dark: #0d1117; --bg-panel: #161b22; --bg-sidebar: #05070a;    
      --path-blue: #007bff; --neon-glow: #00d4ff; --text-main: #e6edf3;     
      --text-muted: #8b949e; --input-bg: #0d1117; --border: #30363d;        
      --error: #ff4b4b; --success: #238636; --modal-overlay: rgba(0, 0, 0, 0.85);
    }

    body { font-family: 'Segoe UI', 'Roboto', sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

    /* --- AUTH STYLES & NUCLEAR AUTOFILL FIX --- */
    #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .auth-box { background: var(--bg-panel); padding: 40px; border-radius: 12px; border: 1px solid var(--border); width: 380px; text-align: center; }
    .input-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
    .auth-input { 
        width: 100%; padding: 12px; padding-right: 45px; background-color: var(--input-bg) !important; 
        border: 1px solid var(--border); color: white !important; border-radius: 6px; box-sizing: border-box; 
        outline: none; transition: 0.2s; -webkit-text-fill-color: white !important;
    }
    input:-webkit-autofill { 
        -webkit-box-shadow: 0 0 0 1000px var(--input-bg) inset !important; 
        transition: background-color 5000s ease-in-out 0s; text-decoration: none !important;
    }
    .toggle-pass { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted); }
    .auth-btn { width: 100%; padding: 12px; background: var(--path-blue); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .switch-link { margin-top: 25px; cursor: pointer; color: var(--text-muted); font-size: 14px; display: inline-block; }
    .switch-link span { color: var(--path-blue); font-weight: bold; text-decoration: underline; }

    /* Password Error Box */
    .req-error { color: var(--error); font-size: 12px; text-align: left; margin-bottom: 15px; background: rgba(255, 75, 75, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(255, 75, 75, 0.2); display: none; }

    /* --- MAIN APP LAYOUT --- */
    #main-app { display: none; width: 100%; height: 100%; }
    #sidebar { width: 72px; background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding-top: 15px; border-right: 1px solid var(--border); }
    .nav-item { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; cursor: pointer; background: var(--bg-panel); border: 1px solid var(--border); transition: 0.2s; }
    .nav-item:hover, .nav-item.active { border-radius: 16px; background: var(--path-blue); color: white; }
    .nav-item.logout { margin-top: auto; border-color: var(--error); color: var(--error); margin-bottom: 20px; }
    .separator { width: 32px; height: 1px; background: var(--border); margin: 5px 0 15px 0; }

    /* --- DASHBOARD & TABS --- */
    #view-main { flex-grow: 1; display: flex; flex-direction: column; }
    .top-bar { height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; background: var(--bg-panel); }
    .friend-tab { padding: 6px 12px; margin: 0 4px; cursor: pointer; color: var(--text-muted); font-size: 14px; border-radius: 6px; font-weight: 500;}
    .friend-tab.active { background: rgba(255,255,255,0.1); color: white; font-weight: 600;}
    .add-btn { background: var(--success); color: white; padding: 6px 14px; border-radius: 4px; font-size: 13px; font-weight: bold; cursor: pointer; margin-left: auto; }

    /* --- FRIEND ITEMS --- */
    #dashboard-view { flex-grow: 1; overflow-y: auto; padding: 20px; }
    .friend-item { display: flex; align-items: center; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; position: relative; background: rgba(255,255,255,0.02); }
    .f-avatar { width: 35px; height: 35px; background: var(--path-blue); border-radius: 50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right: 15px;}
    .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #3ba55c; position: absolute; top: 28px; left: 40px; border: 2px solid var(--bg-dark); }
    .f-name { font-weight: 600; flex-grow: 1; }
    .f-actions { display: flex; gap: 10px; align-items: center; }
    .action-icon { cursor: pointer; color: var(--text-muted); padding: 5px; border-radius: 4px; transition: 0.2s; }
    .action-icon:hover { color: white; background: var(--border); }

    /* --- DROPDOWNS & MODALS --- */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { display: none; position: absolute; right: 0; top: 100%; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; z-index: 50; width: 150px; padding: 5px 0; }
    .dropdown-menu.show { display: block; }
    .dropdown-item { padding: 10px 15px; font-size: 13px; cursor: pointer; color: var(--text-main); }
    .dropdown-item.danger:hover { background: var(--error); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 2000; align-items: center; justify-content: center; }
    .modal { background: var(--bg-panel); padding: 30px; border-radius: 12px; border: 1px solid var(--border); width: 350px; text-align: center; }

    /* --- CHAT --- */
    #chat-view { flex-grow: 1; display: none; flex-direction: column; background: var(--bg-dark); }
    #messages { list-style: none; padding: 20px; overflow-y: auto; flex-grow: 1; margin: 0; }
    .msg-item { display: flex; gap: 12px; margin-bottom: 15px; }
    #chat-form-container { padding: 20px; border-top: 1px solid var(--border); }
    .chat-box { background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; }
    .chat-box input { background: transparent; border: none; color: white; flex-grow: 1; outline: none; }
  </style>
</head>
<body>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal">
      <h2 id="modal-title">Confirm</h2>
      <p id="modal-desc"></p>
      <div style="display: flex; justify-content: center; gap: 15px;">
        <button onclick="closeModal()" style="padding:10px 20px; background:transparent; color:white; border:1px solid var(--border); cursor:pointer; border-radius:6px;">Cancel</button>
        <button id="modal-confirm-btn" style="padding:10px 20px; background:var(--error); color:white; border:none; cursor:pointer; border-radius:6px; font-weight:bold;">Confirm</button>
      </div>
    </div>
  </div>

  <div id="auth-overlay">
    <div id="login-form" class="auth-box">
      <h1>Path</h1>
      <div class="subtitle">To new beginnings.</div>
      <div class="input-wrapper"><input type="text" id="l-user" placeholder="Username" class="auth-input"></div>
      <div class="input-wrapper">
        <input type="password" id="l-pass" placeholder="Password" class="auth-input">
        <span class="toggle-pass" onclick="togglePass('l-pass')">üëÅÔ∏è</span>
      </div>
      <div id="l-error" style="color:var(--error); display:none; font-size:12px; margin-bottom:10px;"></div>
      <button onclick="handleLogin()" class="auth-btn">Log In</button>
      <div class="switch-link" onclick="switchView('register')">Need an account? <span>Register</span></div>
    </div>

    <div id="register-form" class="auth-box" style="display:none;">
      <h1>Register</h1>
      <div class="input-wrapper"><input type="text" id="r-user" placeholder="Username" class="auth-input"></div>
      <div class="input-wrapper"><input type="email" id="r-email" placeholder="Email Address" class="auth-input"></div>
      <div class="input-wrapper"><input type="password" id="r-pass" placeholder="Password" class="auth-input"></div>
      <div class="input-wrapper"><input type="password" id="r-confirm" placeholder="Confirm Password" class="auth-input"></div>
      
      <div id="reg-error-box" class="req-error"></div>

      <button onclick="handleRegister()" class="auth-btn">Create Account</button>
      <div class="switch-link" onclick="switchView('login')">Already have an account? <span>Log In</span></div>
    </div>
  </div>

  <div id="main-app">
    <div id="sidebar">
        <div class="nav-item active" id="nav-h" onclick="showDashboard()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg></div>
        <div class="separator"></div>
        <div class="nav-item logout" onclick="logout()">BYE</div>
    </div>

    <div id="view-main">
        <div class="top-bar" id="top-dash">
            <span style="font-weight: bold; margin-right: 20px;">Friends</span>
            <div class="friend-tab active" onclick="setTab('online')">Online</div>
            <div class="friend-tab" onclick="setTab('all')">All</div>
            <div class="friend-tab" onclick="setTab('pending')">Pending</div>
            <div class="friend-tab" onclick="setTab('blocked')">Blocked</div>
            <div class="add-btn" onclick="setTab('add')">Add Friend</div>
        </div>
        <div class="top-bar" id="top-chat" style="display:none;">
            <b id="chat-header">@ Friend</b>
        </div>

        <div id="dashboard-view">
            <div id="friend-list-content"></div>
        </div>

        <div id="chat-view">
            <ul id="messages"></ul>
            <div id="chat-form-container">
                <form id="chat-form" class="chat-box">
                    <input id="chat-input" placeholder="Message..." autocomplete="off">
                </form>
            </div>
        </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const SERVER_URL = window.location.origin;
    let socket, myId, currentTab = 'online';
    let myData = { friends: [], requests: [], blocked: [] };
    let globalOnlineUsers = [];

    function parseJwt(t) { try { return JSON.parse(atob(t.split('.')[1])); } catch (e) { return null; } }
    function togglePass(id) { const x = document.getElementById(id); x.type = x.type === "password" ? "text" : "password"; }
    function switchView(v) { document.getElementById('login-form').style.display = (v==='login'?'block':'none'); document.getElementById('register-form').style.display = (v==='register'?'block':'none'); }
    function logout() { localStorage.clear(); location.reload(); }
    function toggleDropdown(id) { document.querySelectorAll('.dropdown-menu').forEach(m => { if(m.id !== 'drop-'+id) m.classList.remove('show'); }); const menu = document.getElementById('drop-' + id); if(menu) menu.classList.toggle('show'); }
    function confirmAction(title, desc, actionFn) { document.getElementById('modal-title').innerText = title; document.getElementById('modal-desc').innerText = desc; const btn = document.getElementById('modal-confirm-btn'); btn.onclick = () => { actionFn(); closeModal(); }; document.getElementById('confirm-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }

    async function handleLogin() {
        const u = document.getElementById('l-user').value, p = document.getElementById('l-pass').value;
        const res = await fetch(`${SERVER_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
        const d = await res.json();
        if(res.ok) { localStorage.setItem('path_token', d.token); localStorage.setItem('path_username', u); startApp(); }
        else { const e = document.getElementById('l-error'); e.innerText = d.msg; e.style.display = 'block'; }
    }

    async function handleRegister() {
        const u = document.getElementById('r-user').value, e = document.getElementById('r-email').value, p = document.getElementById('r-pass').value, cp = document.getElementById('r-confirm').value;
        const errBox = document.getElementById('reg-error-box');
        errBox.style.display = 'none';

        if (!u || !e || !p) { errBox.innerText = "Please fill in all fields."; errBox.style.display = 'block'; return; }
        if (p !== cp) { errBox.innerText = "Passwords do not match!"; errBox.style.display = 'block'; return; }

        // --- PASSWORD VALIDATION LOGIC ---
        let missing = [];
        if (p.length < 8) missing.push("8+ characters");
        if (!/[A-Z]/.test(p)) missing.push("1 capital letter");
        if (!/[^a-zA-Z0-9]/.test(p)) missing.push("1 symbol (!@#$)");

        if (missing.length > 0) {
            errBox.innerText = "Missing: " + missing.join(", ");
            errBox.style.display = 'block';
            return;
        }

        try {
            const res = await fetch(`${SERVER_URL}/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, email: e, password: p }) });
            const d = await res.json();
            if(res.ok) { 
                const loginRes = await fetch(`${SERVER_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
                const ld = await loginRes.json();
                localStorage.setItem('path_token', ld.token); localStorage.setItem('path_username', u);
                startApp();
            } else { errBox.innerText = d.msg; errBox.style.display = 'block'; }
        } catch(err) { errBox.innerText = "Server Error"; errBox.style.display = 'block'; }
    }

    function startApp() {
        const token = localStorage.getItem('path_token');
        if(!token) return;
        myId = parseJwt(token).id;
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        socket = io(SERVER_URL);
        socket.emit('identify', myId);
        socket.on('user status change', (ids) => { globalOnlineUsers = ids; renderDashboard(); });
        socket.on('chat message', (msg) => {
            const li = document.createElement('li'); li.className = 'msg-item';
            li.innerHTML = `<div class="f-avatar">${msg.name[0].toUpperCase()}</div><div><b style="color:var(--neon-glow)">${msg.name}</b><br>${msg.text}</div>`;
            document.getElementById('messages').appendChild(li);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        });
        fetchMyData();
    }

    async function fetchMyData() {
        const res = await fetch(`${SERVER_URL}/my-data`, { headers: { 'x-auth-token': localStorage.getItem('path_token') } });
        if(res.ok) { myData = await res.json(); renderDashboard(); }
    }

    function setTab(t) {
        currentTab = t;
        document.querySelectorAll('.friend-tab').forEach(el => {
            el.classList.remove('active');
            if(el.innerText.toLowerCase() === t) el.classList.add('active');
        });
        showDashboard();
    }

    function showDashboard() {
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('chat-view').style.display = 'none';
        document.getElementById('top-dash').style.display = 'flex';
        document.getElementById('top-chat').style.display = 'none';
        renderDashboard();
    }

    function openChat(friendId, friendName) {
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('chat-view').style.display = 'flex';
        document.getElementById('top-dash').style.display = 'none';
        document.getElementById('top-chat').style.display = 'flex';
        document.getElementById('chat-header').innerText = `@ ${friendName}`;
        document.getElementById('messages').innerHTML = '';
        const roomId = [myId, friendId].sort().join('_');
        socket.emit('join room', roomId);
        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const text = document.getElementById('chat-input').value;
            if(text) { socket.emit('private message', { roomId, sender: localStorage.getItem('path_username'), text }); document.getElementById('chat-input').value = ''; }
        };
    }

    function renderDashboard() {
        const container = document.getElementById('friend-list-content');
        container.innerHTML = '';
        if(currentTab === 'add') {
            container.innerHTML = `<div style="text-align:center; padding:40px;"><h3>Add Friend</h3><input id="af-u" class="auth-input" style="width:250px" placeholder="Username"><br><button onclick="sendRequest()" class="auth-btn" style="width:150px">Send Request</button></div>`;
            return;
        }

        let list = [];
        if(currentTab === 'online') list = myData.friends.filter(f => globalOnlineUsers.includes(f._id));
        else if(currentTab === 'all') list = myData.friends;
        else if(currentTab === 'pending') list = myData.requests;
        else if(currentTab === 'blocked') list = myData.blocked;

        if(!list || list.length === 0) { container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding-top:40px;">No users found.</div>`; return; }

        list.forEach(item => {
            const u = item.username || "User", id = item._id || item.from;
            const isOnline = globalOnlineUsers.includes(id);
            const el = document.createElement('div');
            el.className = 'friend-item';
            
            let actions = '';
            if(currentTab === 'all' || currentTab === 'online') {
                actions = `<div class="f-actions"><div class="action-icon" onclick="openChat('${id}', '${u}')">üí¨</div><div class="dropdown"><div class="action-icon" onclick="toggleDropdown('${id}')">‚ãÆ</div><div id="drop-${id}" class="dropdown-menu"><div class="dropdown-item danger" onclick="confirmAction('Unfriend', 'Unfriend ${u}?', () => removeFriend('${id}'))">Remove Friend</div><div class="dropdown-item danger" onclick="confirmAction('Block', 'Block ${u}?', () => blockUser('${id}'))">Block User</div></div></div></div>`;
            } else if(currentTab === 'pending') {
                actions = `<button onclick="acceptFriend('${id}')" style="background:var(--success); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Accept</button>`;
            }

            el.innerHTML = `<div class="f-avatar">${u[0].toUpperCase()}</div>${isOnline ? '<div class="status-dot"></div>' : ''}<div class="f-name">${u}</div>${actions}`;
            container.appendChild(el);
        });
    }

    async function sendRequest() { const t = document.getElementById('af-u').value; const res = await fetch(`${SERVER_URL}/add-friend`, { method:'POST', headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('path_token')}, body:JSON.stringify({targetUsername:t}) }); const d = await res.json(); alert(d.msg); fetchMyData(); }
    async function acceptFriend(id) { await fetch(`${SERVER_URL}/accept-friend`, { method:'POST', headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('path_token')}, body:JSON.stringify({requesterId:id}) }); fetchMyData(); }
    async function removeFriend(id) { await fetch(`${SERVER_URL}/remove-friend`, { method:'POST', headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('path_token')}, body:JSON.stringify({friendId:id}) }); fetchMyData(); }
    async function blockUser(id) { await fetch(`${SERVER_URL}/block-user`, { method:'POST', headers:{'Content-Type':'application/json','x-auth-token':localStorage.getItem('path_token')}, body:JSON.stringify({targetId:id}) }); fetchMyData(); }

    window.onload = () => { if(localStorage.getItem('path_token')) startApp(); }
  </script>
</body>
</html>