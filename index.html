<!DOCTYPE html>
<html>
<head>
  <title>Path Project</title>
  <style>
    :root {
      --background-dark: #0d1117;
      --background-sidebar: #05070a;
      --path-blue: #007bff;
      --neon-glow: #00d4ff;
      --text-main: #e6edf3;
      --text-muted: #7d8590;
      --input-bg: #161b22;
      --error-red: #ff4b4b;
    }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--background-dark); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
    
    /* --- Auth Overlay CSS --- */
    #auth-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--background-dark);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .auth-box { background: var(--background-sidebar); padding: 40px; border-radius: 12px; border: 1px solid #30363d; width: 350px; text-align: center; }
    
    /* Input Labels */
    .input-label { display: block; text-align: left; font-size: 11px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
    
    .auth-input { width: 100%; padding: 12px; margin-bottom: 20px; background: var(--input-bg); border: 1px solid #30363d; color: white; border-radius: 5px; box-sizing: border-box; outline: none; }
    .auth-input:focus { border-color: var(--path-blue); }

    .auth-btn { width: 100%; padding: 12px; background: var(--path-blue); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 5px; }
    .auth-btn:hover { background: var(--neon-glow); }

    /* The Link Styling - Big and Visible */
    .switch-link { margin-top: 20px; font-size: 14px; cursor: pointer; }
    .switch-link span { color: var(--text-muted); }
    .switch-link strong { color: var(--path-blue); }
    .switch-link:hover strong { text-decoration: underline; }

    .error-msg { font-size: 12px; margin-top: 10px; color: var(--error-red); display: none; }

    /* --- Existing Chat CSS --- */
    #main-app { display: none; width: 100%; height: 100%; display: flex; } 
    #sidebar { width: 72px; background-color: var(--background-sidebar); display: flex; flex-direction: column; align-items: center; padding-top: 15px; border-right: 1px solid #1f242c; }
    .server-icon { width: 54px; height: 54px; background: var(--path-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 14px; text-transform: uppercase; cursor: pointer; }
    #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1f242c; padding-right: 15px; }
    h2 { font-size: 16px; padding: 15px; margin: 0; color: var(--path-blue); }
    ul { list-style-type: none; padding: 20px; overflow-y: auto; flex-grow: 1; margin: 0; }
    li { margin-bottom: 12px; padding: 10px; border-radius: 8px; background: rgba(255, 255, 255, 0.02); }
    .username { color: var(--neon-glow); font-weight: bold; margin-right: 8px; }
    .timestamp { color: var(--text-muted); font-size: 0.75rem; }
    #form-container { padding: 20px; }
    form { background-color: var(--input-bg); border: 1px solid #30363d; border-radius: 10px; display: flex; padding: 5px 15px; gap: 10px; }
    input { background: transparent; border: none; color: white; padding: 10px 0; flex-grow: 1; outline: none; }
    #username-display { color: var(--path-blue); font-weight: bold; border-right: 1px solid #30363d; padding-right: 10px; line-height: 35px; }
    .logout-btn { color: var(--text-muted); background: none; border: none; cursor: pointer; font-size: 12px; }
  </style>
</head>
<body>

  <div id="auth-overlay">
    
    <div id="login-form" class="auth-box">
      <h1 style="color: var(--path-blue); margin-bottom: 5px;">Path</h1>
      <p style="color: var(--text-muted); margin-bottom: 30px;">Welcome back!</p>
      
      <div>
        <label class="input-label">USERNAME</label>
        <input type="text" id="login-user" class="auth-input">
      </div>
      <div>
        <label class="input-label">PASSWORD</label>
        <input type="password" id="login-pass" class="auth-input">
      </div>
      
      <div id="login-error" class="error-msg"></div>

      <button id="login-btn" class="auth-btn" onclick="handleLogin()">Login</button>
      
      <div class="switch-link" onclick="switchView('register')">
        <span>Need an account?</span> <strong>Register</strong>
      </div>
    </div>

    <div id="register-form" class="auth-box" style="display: none;">
      <h1 style="color: var(--path-blue); margin-bottom: 5px;">Create Account</h1>
      <p style="color: var(--text-muted); margin-bottom: 30px;">Join the project</p>
      
      <div>
        <label class="input-label">USERNAME</label>
        <input type="text" id="reg-user" class="auth-input">
      </div>
      <div>
        <label class="input-label">PASSWORD</label>
        <input type="password" id="reg-pass" class="auth-input">
      </div>
      
      <div id="reg-error" class="error-msg"></div>

      <button id="register-btn" class="auth-btn" onclick="handleRegister()">Continue</button>
      
      <div class="switch-link" onclick="switchView('login')">
        <span>Already have an account?</span> <strong>Log In</strong>
      </div>
    </div>

  </div>

  <div id="main-app" style="display: none;">
    <div id="sidebar"><div class="server-icon">Path</div></div>
    <div id="chat-container">
      <div class="header">
        <h2># general-chat</h2>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
      <ul id="messages"></ul>
      <div id="form-container">
        <form id="form">
          <div id="username-display">User</div>
          <input id="input" placeholder="Message Path Project..." autocomplete="off" />
          <button type="submit" style="display:none"></button>
        </form>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const mainApp = document.getElementById('main-app');
    const authOverlay = document.getElementById('auth-overlay');
    const userDisplay = document.getElementById('username-display');

    // SERVER CONFIG
    const SERVER_URL = window.location.origin.includes('http') 
                       ? window.location.origin 
                       : 'https://path-project.onrender.com';

    // --- SESSION PERSISTENCE ---
    window.onload = function() {
      const savedToken = localStorage.getItem('path_token');
      const savedName = localStorage.getItem('path_username');
      
      if (savedToken && savedName) {
        startChat(savedName);
      }
    };

    // --- SWITCH BETWEEN LOGIN & REGISTER ---
    function switchView(view) {
      document.getElementById('login-error').style.display = 'none';
      document.getElementById('reg-error').style.display = 'none';

      if (view === 'register') {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
      } else {
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
      }
    }

    // --- LOGIN LOGIC ---
    async function handleLogin() {
      const user = document.getElementById('login-user').value;
      const pass = document.getElementById('login-pass').value;
      const errorDiv = document.getElementById('login-error');

      if (!user || !pass) {
        errorDiv.innerText = "Please fill in all fields";
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${SERVER_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });

        const data = await response.json();

        if (response.ok) {
          localStorage.setItem('path_token', data.token);
          localStorage.setItem('path_username', user);
          startChat(user);
        } else {
          errorDiv.innerText = data.msg || "Login failed";
          errorDiv.style.display = 'block';
        }
      } catch (e) {
        errorDiv.innerText = "Server connection failed.";
        errorDiv.style.display = 'block';
      }
    }

    // --- REGISTER LOGIC ---
    async function handleRegister() {
      const user = document.getElementById('reg-user').value;
      const pass = document.getElementById('reg-pass').value;
      const errorDiv = document.getElementById('reg-error');

      if (!user || !pass) {
        errorDiv.innerText = "Please fill in all fields";
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${SERVER_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });

        const data = await response.json();

        if (response.ok) {
          // SUCCESS: Switch to login and autofill name
          alert("Account created! Redirecting to login...");
          switchView('login');
          document.getElementById('login-user').value = user;
          document.getElementById('login-pass').focus();
        } else {
          errorDiv.innerText = data.msg || "Registration failed";
          errorDiv.style.display = 'block';
        }
      } catch (e) {
        errorDiv.innerText = "Server connection failed.";
        errorDiv.style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('path_token');
      localStorage.removeItem('path_username');
      location.reload();
    }

    // --- CHAT LOGIC ---
    function startChat(username) {
      authOverlay.style.display = 'none';
      mainApp.style.display = 'flex';
      userDisplay.innerText = username;

      var socket = io(SERVER_URL);
      var form = document.getElementById('form');
      var input = document.getElementById('input');
      var messages = document.getElementById('messages');

      form.onsubmit = function(e) {
        e.preventDefault();
        if (input.value) {
          socket.emit('chat message', { name: username, text: input.value });
          input.value = '';
        }
      };

      socket.on('chat message', function(msg) {
        var item = document.createElement('li');
        var time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        item.innerHTML = `<div><span class="username">${msg.name}</span><span class="timestamp">${time}</span></div><div>${msg.text}</div>`;
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
      });

      socket.on('connect_error', (err) => {
        console.error("Chat connection error:", err);
      });
    }
  </script>
</body>
</html>